<html>
<head>
  <title>joola.io SDK Example</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"/>
  <style type="text/css" media="screen">
    #editor {
      border: 2px solid #ddd;
      height: 300px;
    }

    #editor2 {
      border: 2px solid #ddd;
      height: 300px;
    }

    #editor3 {
      border: 2px solid #ddd;
      height: 300px;
    }

    #chart {
      height: 300px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>joola.io Playground</h1>

  <p class="lead">
    This example page collects information and events generated by your web browser and stores them in joola.io.
    Data
    is then queried in as meaningful KPI and shown as both metrics and sparklines.
  </p>

  <div class="row">
    <div class="col-lg-5">

      <div id="editor">{
        "timestamp": null,
        "user": "itay",
        "browser": "chrome",
        "event": 1
        }
      </div>
    </div>
    <div class="col-lg-1">
      <button id="push" class="btn btn-default btn-primary" style="margin-top:130px;margin-left:-5px">Push =>
      </button>
    </div>
    <div class="col-lg-6">
      <div id="editor3">
      </div>
    </div>
  </div>

  <hr>

  <div class="row">
    <div class="col-lg-5">
      <div id="editor2">{
        "timeframe": "last_hour",
        "interval": "minute",
        "dimensions": ["timestamp"],
        "metrics": ["event"],
        "realtime":{
        "enabled":true,
        "interval":5000
        }
        }
      </div>
    </div>
    <div class="col-lg-1">
      <button id="query" class="btn btn-default btn-primary" style="margin-top:130px;margin-left:-5px">Query =>
      </button>
    </div>
    <div class="col-lg-6">
      <div id="chart"></div>
    </div>
  </div>
</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>

<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
  var editor = ace.edit("editor");
  // editor.setTheme("ace/theme/monokai");
  editor.getSession().setMode("ace/mode/javascript");

  var editor2 = ace.edit("editor2");
  //editor2.setTheme("ace/theme/monokai");
  editor2.getSession().setMode("ace/mode/javascript");

  var editor3 = ace.edit("editor3");
  //editor3.setTheme("ace/theme/monokai");
  editor3.getSession().setMode("ace/mode/javascript");
</script>

<script src="/joola.io.js"></script>
<script>
  joolaio.init({APIToken: 'apitoken-root'}, function (err) {
    if (err)
      throw err;
  });
</script>

<script>
  var uid = 'TEST';//joolaio.common.uuid();
  $('#push').on('click', function () {
    var json = editor.getSession().getValue();
    try {
      json = JSON.parse(json);
      joolaio.beacon.insert('playground-' + uid, json, function (err, result) {
        if (err)
          editor3.getSession().setValue(err);

        var text = JSON.stringify(result, null, 4);
        editor3.getSession().setValue(text);
      });
    }
    catch (ex) {
      console.log(ex);
      console.log(ex.stack);
      editor3.getSession().setValue(ex);
    }
  });


  console.log('playground-' + uid);

  var plot = function () {
    var json = editor2.getSession().getValue();
    try {
      json = JSON.parse(json);
      json.collection = 'playground-' + uid;
      var metrics = [];
      json.metrics.forEach(function (m) {
        if (typeof m === 'object') {
          m.collection = 'playground-' + uid;
        }
        else {
          m = {
            key: m,
            collection: 'playground-' + uid
          };
        }
        metrics.push(m);
      });
      json.metrics = metrics;
      $('#chart').Sparkline({
        force: true,
        /*chart: {
          chart: {
            type: 'column'
          },
          plotOptions: {
            series: {
              pointPadding: 0.05,
              groupPadding: 0.1,
              borderWidth: 0,
              shadow: false
            }
          }
        },*/
        query: json
      });
    }
    catch (ex) {
      console.log(ex);
      editor3.getSession().setValue(ex);
    }
  };

  $('#query').on('click', function () {
    plot();
  });
</script>
</body>
</html>

